---
title: "AVR入門その１"
date: 2023-03-07T13:09:51+09:00
archives:
    - 2023-03
draft: false
categories: [Electronics]
tags:
    - AVR
---

[前回](../day0/)の続きです。今回はLEDをチカチカさせます。

---

# 目次

* [はじめに(ハードウェア編)](../day0/)
* [はじめに(ソフトウェア編)](../day0.5/)
* 第1回 レジスタとLチカ　←ここ
* [第2回 7セグメントLED](../day2/)
* [第3回 ダイナミック点灯](../day3/)
* [第4回 タイマ割り込み](../day4/)
* [第5回 サーミスタとAD変換](../day5/)


---
## 6. プログラミング言語について

AVRはアセンブリ言語かC/C++言語で開発できます。私はアセンブリ言語は分からないので、今回はC言語を使って開発します。

C言語の勉強ですが、恐らく私が書いたものよりも[苦しんで覚えるC言語](https://9cguide.appspot.com/)を読んだほうが良いかと思います。必要十分量の情報が分かりやすくまとまっています。


## 7. プログラム

とりあえず、プログラムを書いてみましょう。今回のは以下のようになります。

```cpp
#include<avr/io.h>
#include<util/delay.h>

int main(void){
	DDRC=0b00000001;//入出力モードを設定
	while(1){
		PORTC=0b00000001;//点灯
		_delay_ms(1000);//一秒待つ
		PORTC=0b00000000;//消灯
		_delay_ms(1000);//一秒待つ
	}
	return 0;
}
```


## 8. プログラムを書き込む

ついにプログラムを書き込みます。

1. 前回の`4.2.配線する`に従ってライターとマイコンを接続します。
1. Arduino IDEを立ち上げて、作ったプログラムを書きます。
![](img/fig2.png)
1. ライターとPCを繋げます。
1. Ctrl+Shift+Uと押せば書き込むことができます。

## 9. ピンについて

今回使うマイコンICのATmega88には足がたくさんあり、この足をピンといいます。ピンにはそれぞれ役割が与えられていて、プログラムで役割を切り替えることになります。また、図のようにそれぞれのピンには名前が割り当てられています。

![](img/fig1.png)

何も設定しない状態だと、ATmega88は以下のピンが使えます。（これらをIOポートといいます。）

- PB0,PB1,PB2,PB3,PB4,PB5
- PC0,PC1,PC2,PB3,PC4,PC5,PC6
- PD0,PD1,PD2,PD3,PD4,PD5,PD6,PD7

通常ピンは8本ずつ単位で取り扱い、Bポート、Cポートのように呼びます。ATmega88の場合は、Dポートが全てありますが、Cポートは7本、Bポートは6本だけ出ています。

上のプログラムではPC0に繋がったLEDをチカチカさせます。


## 10. AVRマイコンのメモリ

AVRのメモリはプログラム用とデータ用に分かれています。

プログラム用メモリはCPUに命令を送るためのメモリであり、ROMが使われています。ここにデータを書き込むためにはライターが必要です。

データ用のメモリはCPUが読み書きできるメモリです。SRAMなどがあります。
SRAMは8bitのデータを持つレジスタからなります。このレジスタにも２種類あります。
データを保存するレジスタとマイコンを操作するためのレジスタです。ここでは詳しくは書きませんが、「レジスタを読み書きすることでマイコンを操作できる」ということを覚えておいてください。


## 11. レジスタ

ここで、マイコンのメモリの構造を見てみます。

AVRマイコンのメモリは、プログラムを格納する部分とプログラムが操作できる部分に分かれています。(このような構造をハーバード・アーキテクチャといいます)

ROMは書き込み専用で、書き込むためにはライターを使います。書き込み方については後で説明します。

さらにSRAMのなかには、マイコンの色んな機能を制御する**レジスタ**というものがあります。

DDR (Data Direction Register)はそのひとつです。これはビットそれぞれに対応するピンの入出力モードを変えることができます。

DDRのビットを0にすると入力モード、1にすると出力モードになります。

|ビット|7|6|5|4|3|2|1|0|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|ピン|-|PC6|PC5|PC4|PC3|PC2|PC1|PC0|
|値|-|0|0|0|1|0|0|1|

例えば、上のようにPORTCのPC0とPC3だけを出力モードにするなら、以下のように書きます。
```c
DDRC=0b00001001;
```
ここで`0b`というのは二進数ということを表しています。

### （参考）
レジスタはメモリの一種なのでアドレスを持っています。このアドレスを定義しているのが`avr/io.h`です。

## 12. 何もしないプログラム

まず、「何もしないコード」について説明します。

```cpp
#include<avr/io.h>
int main(void){
	// 初期化処理はここで
	while(1){
		// 繰り返し行う処理はここで
	}
	return 0;
}

```

C言語では、処理を「関数」というものでまとめています。上のコードではmain関数だけあります。

プログラムの処理はmain関数から始まります。main関数の中身を一行ずつ実行していきます。

基本的には関数には順番はありません。main関数から呼び出された順番で実行されます。

```cpp
while(1){

}
```

ここの部分は無限ループと呼ばれていて、「{}」の中身を無限に繰り返します。マイコンにさせたい処理の大部分はここに書きます。

これから書くプログラムは、何もしないプログラムをベースに書いていきます。

## 13. プログラムの中身

では、最初のプログラムでどのようなことをやっているのかを見てみましょう。

### 13.1. 初期化処理

```cpp
	DDRC=0b00000001;//入出力モードを設定
```

まず、`DDRC`を使ってポートCの入出力モードを設定します。ここではPC0だけを出力モードにするので、`0b00000001`となります。

**PORTC**はポートCのピンのHIGH/LOWを決めるレジスタです。DDRと同様にビットに対応するピンのHIGH/LOWを決めることができます。ビットに1を書き込むとHIGH、0を書き込むとLOWとなります。

### 13.2. 無限ループ

```cpp
	while(1){
		PORTC=0b00000001;//点灯
		_delay_ms(1000);//一秒待つ
		PORTC=0b00000000;//消灯
		_delay_ms(1000);//一秒待つ
	}
```

今回のプログラムではPC0のHIGH/LOWを変えます。例えば、PC0に繋がったLEDをONにしたいなら、以下のようにビットを設定します。

|ビット|7|6|5|4|3|2|1|0|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|ピン|-|PC6|PC5|PC4|PC3|PC2|PC1|PC0|
|値|-|0|0|0|0|0|0|1|


```_delay_ms()```は指定した時間(ms)だけ待機する関数です。上のプログラムでは、1秒(=1000ms)ごとにLEDのON/OFFを切り替えています。

---


以上で第一回は終わりです。[次回](../day2/)は7セグメントLEDを使います。
